# 编写Api

第一部分讲的是数据模型和数据库的简单操作，课程模型已经建立起来了，这节提供Api，这样下节，我们就可以编写h5页面了。本节其实是承上启下的章节。

## express

安装

```
$ npm i -g express-generator
$ express .


  warning: the default view engine will not be jade in future releases
  warning: use `--view=jade' or `--help' for additional options

destination is not empty, continue? [y/N] y

   create : .
   create : ./package.json
   create : ./app.js
   create : ./public
   create : ./routes
   create : ./routes/index.js
   create : ./routes/coursess.js
   create : ./views
   create : ./views/index.jade
   create : ./views/layout.jade
   create : ./views/error.jade
   create : ./bin
   create : ./bin/www
   create : ./public/javascripts
   create : ./public/images
   create : ./public/stylesheets
   create : ./public/stylesheets/style.css

   install dependencies:
     $ cd . && npm install

   run the app:
     $ DEBUG=coursehaha:* npm start
```

启动

```
$ npm install
$ npm start
```

此时访问http://127.0.0.1:3000/是正常的。

## 使用nodemon

```
$ npm i -D nodemon  
```

修改package.json

  "scripts": {
    "start": "./node_modules/.bin/nodemon app.js"
  },

## 集成db

对于db来说，都是一样的。操作mongodb使用的是mongoose模块。

db.js就是mongoose连接数据库的。

所以，在app.js引入db.js即可，即在server启动之前就要连接数据库。

```
require('./db')
```

```
$ npm i -S mount-routes
```

移除

```
var index = require('./routes/index');
var coursess = require('./routes/coursess');

app.use('/', index);
app.use('/coursess', coursess);
```

新增

```
var mount = require('mount-routes');

// with path & api dump
mount(app,  __dirname + '/routes', true);
```

然后我们在routes里创建api/courses.js

```
var express = require('express');
var router = express.Router();

/* GET coursess listing. */
router.get('/', function(req, res, next) {
  res.json({
    a:1
  });
});

module.exports = router;
```

启动服务器，访问，返回json里a是1即可

http://127.0.0.1:3000/api/courses

## 实现3个api

标准restful api

```
/**
 * Auto generate RESTful url routes.
 *
 * URL routes:
 *
 *  GET    /api/coursess[/]        => course.list()
 *  GET    /api/coursess/new       => course.new()
 *  GET    /api/coursess/:id       => course.show()
 *  GET    /api/coursess/:id/edit  => course.edit()
 *  POST   /api/coursess[/]        => course.create()
 *  PATCH  /api/coursess/:id       => course.update()
 *  DELETE /api/coursess/:id       => course.destroy()
 *
 */
```
### 课程列表api

 *  GET    /api/coursess[/]        => course.list()

http://127.0.0.1:3000/api/courses


```
var Course = require('../../app/model/course')
// console.log(Course)

/* GET users listing. */
router.get('/', function(req, res, next) {
  var all = Course.all(function (err, users) {
    console.log(users)
    res.json({
      data: {
        users: users
      },
      status: {
        code:0,
        msg: "sucess"
      }
    })
  })
});
```

结果：

```
// 20171027064104
// http://127.0.0.1:3000/api/courses

{
  "data": {
    "users": [
      {
        "_id": "59efc22cca69d2122ce75823",
        "name": "系统掌握深度学习，从入门到精通实战",
        "category": "/首页/人工智能/系统掌握深度学习",
        "price": "2999",
        "picture": "https://new.stuq.org/files/default/2017/08-08/120213522984724939.jpg",
        "status": "更新中",
        "plan": "教学计划：系统掌握深度学习，从...",
        "effect_duration": "学习有效期：365 天（随到随学）",
        "prompt": "课程原价 4999 元，现在限名额优惠，报名请尽快扫码咨询课程小助手",
        "target": "让学员掌握机器学习、深度学习基本原理",
        "target_user": "有一定编程基础，对深度学习有浓厚兴趣",
        "evaluation_count": 103,
        "evaluation_average_number": 4.9,
        "__v": 0,
        "toc": [
          
        ],
        "latest_students": [
          
        ],
        "student_trend": [
          
        ]
      },
      {
        "_id": "59efc22cca69d2122ce75824",
        "name": "TensorFlow实战——基础班",
        "category": "/首页/人工智能/TensorFlow实战——基础班",
        "price": "1999",
        "picture": "https://new.stuq.org/files/default/2017/08-07/171053d85903252716.jpg",
        "status": "更新中",
        "plan": "暂无",
        "effect_duration": "开始：2017-09-02   截止：2018-09-02",
        "prompt": "课程原价：2599元，“1024”活动价：1799元，扫码立即购买。",
        "target": " 此课程将深入浅出的介绍深度学习的基本概念和常用模型，并给出使用TensorFlow实现这些模型和算法的最佳实践。",
        "target_user": "基础的编程能力，可以读懂基本的python代码",
        "evaluation_count": 103,
        "evaluation_average_number": 4.9,
        "__v": 0,
        "toc": [
          
        ],
        "latest_students": [
          
        ],
        "student_trend": [
          
        ]
      }
    ]
  },
  "status": {
    "code": 0,
    "msg": "sucess"
  }
}
```

### 课程详情api

 *  GET    /api/coursess/:id       => course.show()

http://127.0.0.1:3000/api/courses/59efc22cca69d2122ce75823

测试db的代码

```
var db = require('./db')
var Course = require('./app/model/course')
// console.log(Course)

// db.once('open', function () {
//     var all = Course.all(function (err, users) {
//         console.log(users)
//     })
// })

db.once('open', function () {
    var course = Course.getById('59efc22cca69d2122ce75823',function (err, users) {
        console.log(users)
    })
})
```

路由

```
/* GET user detail. */
router.get('/:id', function (req, res, next) {
  var user_id = req.params.id
  Course.getById(user_id, function (err, user) {
    console.log(user)
    res.json({
      data: {
        user: user
      },
      status: {
        code: 0,
        msg: "sucess"
      }
    })
  })
});
```

返回结果

```
// 20171027064702
// http://127.0.0.1:3000/api/courses/59efc22cca69d2122ce75823

{
  "data": {
    "user": {
      "_id": "59efc22cca69d2122ce75823",
      "name": "系统掌握深度学习，从入门到精通实战",
      "category": "/首页/人工智能/系统掌握深度学习",
      "price": "2999",
      "picture": "https://new.stuq.org/files/default/2017/08-08/120213522984724939.jpg",
      "status": "更新中",
      "plan": "教学计划：系统掌握深度学习，从...",
      "effect_duration": "学习有效期：365 天（随到随学）",
      "prompt": "课程原价 4999 元，现在限名额优惠，报名请尽快扫码咨询课程小助手",
      "target": "让学员掌握机器学习、深度学习基本原理",
      "target_user": "有一定编程基础，对深度学习有浓厚兴趣",
      "evaluation_count": 103,
      "evaluation_average_number": 4.9,
      "__v": 0,
      "toc": [
        
      ],
      "latest_students": [
        
      ],
      "student_trend": [
        
      ]
    }
  },
  "status": {
    "code": 0,
    "msg": "sucess"
  }
}
```

### 课程创建api

 *  POST   /api/coursess[/]        => course.create()
 
 
 db_test.js
 
```
require('./db')

var Course = require('./app/model/course')
// console.log(Course)

Course.create({
    name: "系统掌握深度学习，从入门到精通实战", //课程名称
    category: "/首页/人工智能/系统掌握深度学习",
    price: 2999, //价格
    picture: "https://new.stuq.org/files/default/2017/08-08/120213522984724939.jpg" ,//头图
    status: "更新中", //状态标签：更新中、直播课程、不可用
    plan: "教学计划：系统掌握深度学习，从...", //教学计划：系统掌握深度学习，从...
    effect_duration: "学习有效期：365 天（随到随学）", //学习有效期：365 天（随到随学）
    prompt: "课程原价 4999 元，现在限名额优惠，报名请尽快扫码咨询课程小助手", //课程提示： 课程原价 4999 元...
    target: "让学员掌握机器学习、深度学习基本原理", //课程目标
    target_user: "有一定编程基础，对深度学习有浓厚兴趣", //适合人群
    student_trend: [], //学员动态：（5条，xxx加入学习）
    evaluation_count: 103, //当评价表增加新数据，异步更新
    evaluation_average_number: 4.9, //当评价表增加新数据，异步更新
    latest_students: [], //最新学员（多个，最多20）
    toc: [], //目录
})
```
 
 而post唯一要做的就是处理从req.body里获取参数
 
 
``` 
 /* POST create user */
 router.post('/', function (req, res, next) {
   Course.create({
       name: req.body.name || "系统掌握深度学习，从入门到精通实战", //课程名称
       category: req.body.category || "/首页/人工智能/系统掌握深度学习",
       price:req.body.price ||  2999, //价格
       picture: req.body.picture || "https://new.stuq.org/files/default/2017/08-08/120213522984724939.jpg" ,//头图
       status: req.body.status || "更新中", //状态标签：更新中、直播课程、不可用
       plan: req.body.plan || "教学计划：系统掌握深度学习，从...", //教学计划：系统掌握深度学习，从...
       effect_duration:req.body.effect_duration ||  "学习有效期：365 天（随到随学）", //学习有效期：365 天（随到随学）
       prompt: req.body.prompt || "课程原价 4999 元，现在限名额优惠，报名请尽快扫码咨询课程小助手", //课程提示： 课程原价 4999 元...
       target:req.body.target ||  "让学员掌握机器学习、深度学习基本原理", //课程目标
       target_user:req.body.target_user ||  "有一定编程基础，对深度学习有浓厚兴趣", //适合人群
   },function(err, course){
     res.json({
       data: {
         course: course
       },
       status: {
         code: 0,
         msg: "sucess"
       }
     })
   })
 });
 ```
 
 测试
 
 ```
 curl -d "name=createwithcurl" http://127.0.0.1:3000/api/courses/        
```

结果

``` {"data":{"course":{"__v":0,"name":"createwithcurl","category":"/首页/人工智能/系统掌握深度学习","price":"2999","picture":"https://new.stuq.org/files/default/2017/08-08/120213522984724939.jpg","status":"更新中","plan":"教学计划：系统掌握深度学习，从...","effect_duration":"学习有效期：365 天（随到随学）","prompt":"课程原价 4999 元，现在限名额优惠，报名请尽快扫码咨询课程小助手","target":"让学员掌握机器学习、深度学习基本原理","target_user":"有一定编程基础，对深度学习有浓厚兴趣","_id":"59f269020b00087639db4906","toc":[],"latest_students":[],"student_trend":[]}},"status":{"code":0,"msg":"sucess"}}%
```